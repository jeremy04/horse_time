<script>
  

  $( document ).ready(function() {

    var client = new Faye.Client('/faye')
    client.disable('websocket');
    
    $("#start_game").on("click", function(event){
      console.log("CLICKED");
      event.preventDefault();
      var horse_team = $("#horse_team").val();
      var horses_per = $("#horses_per").val();

      $.post('/generate_draft.json', { horses_per: horses_per, 
                                       horse_team: horse_team, 
                                       room_code: "<%= @room_code %>" 
                                     }, 
        function(returnedData){
          console.log("Page reloading");
       
         window.location.reload();
         client.publish('/game_on', {
            game: "start"
          });
      });


    });


    client.publish('/signon', {
      user: "<%= @user %>"
     });



    client.subscribe('/game_on', function(message) {
      console.log("Page reloading");
      window.location.reload();
    });

    client.subscribe('/acknowledge', function(message) {
      $("#" + message.user + "_img").css("display", "inline");      
    });
 
    client.subscribe('/signon', function(message) {
      client.publish('/acknowledge', {
        user: "<%= @user %>"
      });  


      if($("#" + message.user).length == 0) {
        console.log("Adding");
        $("#whos_online").append("<div id=\"" 
          + message.user + "\" class=\"row\">" 
          + message.user
          + "<img id=\"" + message.user 
          + "_img\"" 
          + "src=\"/img/purple_devil.png\" width=\"5%\" height=\"5%\">"
          + "</div>");
      }
      else {
        $("#" + message.user + "_img").css("display", "inline");
      }


    });

  });

</script>
<div class="row">
  <div class="col-md-4">
    <h2>GAME IS ABOUT TO START, <%= @user %></h2>
    <h3>Room Code: <%= @room_code %></h3>
  </div>
</div>
<div class="row">
  <div class="col-md-4">
    Room Manager: <%= @manager ? @manager : '(Manager has quit.. )' %>
  </div>
</div>

<div class="row">
  <div class="col-md-4" id="whos_online">
    <% @players.each do |player| %>
      <div id="<%= player %>" class="row">
        <%= player %><img style="display: none" id="<%= player %>_img" src="/img/purple_devil.png" width="5%" height="5%">
      </div>
    <% end %>
  </div>
</div>

<% if @manager == @user %>
<div class="row">
  <div class="col-md-4">
    <p>
      <form role="form">
        <div class="form-group">
          <label for="sel1">Select team (select one):</label>
          <select class="form-control" id="horse_team">
            <% @teams.each do |team| %>
              <option value="<%= team.first %>"><%= team.first %> vs. <%= team[1] %></option>
            <% end %>
          </select>
          <label for="sel1">Horses per team:</label>
          <select class="form-control" id="horses_per">
              <option selected value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
              <option value="5">5</option>
              <option value="6">6</option>
          </select>

        </div>
      </form>
    </p>

    <p><a class="btn btn-default" id="start_game" role="button">EVERYONES IN GUYS</a></p>
  </div>
</div>
<% end %>
<hr>